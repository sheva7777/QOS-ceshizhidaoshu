1	引言
MA5600 V800R005作为MA5600T的最新版本，为了适应宽带大量接入、语音少量接入的市场应用定位，以及传统宽带和GPON产品的特性拉齐，在硬件和软件方面都有较大规模的改动。在QoS特性上，也与以前版本有较大不同。
从应用的角度分析，QoS新增或者改动的功能主要表现在以下几个方面：
1、IP流量模板和ATM流量模板的分离管理
2、双速率三色IP流量管理
3、在基于流和基于端口+CoS的多种流量管理方式
4、调度队列的功能增强
5、优先级策略
	对于LSW上的QoS功能，实现同前面版本一致，这里不再做详细解释。本文针对以前接触过QoS测试的同学，强调的重点是V8R5和以前版本的不同点。


2	QoS的实现
2.1	流量模板
在V8R5之前的版本上，流量模板只有一种，不区分IP流量模板或者是ATM流量模板，一共可以建立1024个。很明显随着IP应用的发展，对IP业务的QoS要求越来越高，因此分离IP流量模板，增强IP流量模板的流量参数为大势所趋。分离后的ATM和IP流量模板各自维护各自的一套参数。对于AIUG单板，固定使用ATM流量模板；在不使用AIUG上行的情况下，对于各种XDSL单板、ETH接入板、GPON单板则采用IP流量模板。对于上行为AIUG接口，下行为XDSL接入的时候，系统需要建立PVC业务流，绑定ATM流量模板。在这种情况下，ATM流量模板参数一方面下发到AIUG的APC新片中，一方面还要转换成IP流量参数下发到XDSL的逻辑中。ATM和IP流量模板分别可以建立512个。
总结一句话就是除了在AIUG上建立service-port，其它情况下都是使用IP流量模板。V8R5引入了端口加802.1P作CAR，使用该方式时也要引用IP流量模板，在测试的时候需要注意。
2.2	双速三色CAR
协议中双速三色CAR的方式有两种：Color-Blind模式和Color-Aware，Color-Blind模式下逻辑不关心报文原来是什么颜色，而Color-Aware需要考虑报文原来的颜色。目前主机不支持Color-Aware，默认就是Color-Blind模式，也没有提供任何开关给我们选择。双速直接体现在逻辑中有两个令牌桶，这两个令牌桶分别为桶P和桶C；桶P的深度为PBS，桶C的深度为CBS；桶P放置令牌的速度为PIR，桶C放置令牌的速度为CIR，其中CIR必须小于等于PIR。一个令牌可以允许64kb报文通过，所以当我们设置CIR和PIR的时候，如果不是64的整数倍，则会向下取最近的一个64倍速的值。报文通过时，可以理解为首先通过桶P，如果令牌足够通过，则在桶中减去相应的令牌数，到达桶C，如果令牌数不够报文通过，则直接丢弃；到达桶C后，同样如果令牌足够通过，则在桶中减去相应的令牌数，报文为绿色发出；不够报文通过时，无需减去令牌数直接把报文标记为黄色发出。
	目前设备送出来的报文只有绿色和黄色报文，我们可以通过相应的字段直接观察报文颜色。
